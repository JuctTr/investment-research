// 投研分析系统数据库模型
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户模型
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关系
  contents    Content[]
  viewpoints  Viewpoint[]
  decisions   Decision[]
  reviews     Review[]

  @@map("users")
}

// 内容模型 - 存储各种投研资料
model Content {
  id          String      @id @default(cuid())
  title       String
  description String?
  url         String?
  content     String?     // 原始内容
  contentType ContentType @default(ARTICLE)
  tags        String[]    // 标签数组
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // 关系
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  viewpoints Viewpoint[]  // 关联的观点

  @@map("contents")
}

// 观点模型 - 用户对内容的分析和观点
model Viewpoint {
  id          String       @id @default(cuid())
  title       String
  summary     String       // 观点摘要
  analysis    String       // 详细分析
  confidence  Int          // 信心程度 1-10
  outlook     OutlookType  @default(NEUTRAL) // 市场展望
  tags        String[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // 关系
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  contentId  String?
  content    Content?     @relation(fields: [contentId], references: [id], onDelete: SetNull)
  decisions  Decision[]   // 关联的决策

  @@map("viewpoints")
}

// 决策模型 - 基于观点做出的投资决策
model Decision {
  id           String       @id @default(cuid())
  title        String
  description  String       // 决策描述
  action       ActionType   @default(BUY) // 买入/卖出/持有
  amount       Float        // 金额/数量
  price        Float?       // 价格
  reason       String       // 决策理由
  status       DecisionStatus @default(PLANNING) // 计划中/已执行/已完成
  confidence   Int          // 信心程度 1-10
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // 关系
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  viewpointId String?
  viewpoint   Viewpoint?   @relation(fields: [viewpointId], references: [id], onDelete: SetNull)
  reviews     Review[]     // 关联的复盘

  @@map("decisions")
}

// 复盘模型 - 对决策结果的复盘分析
model Review {
  id          String      @id @default(cuid())
  title       String
  summary     String      // 复盘总结
  result      ReviewResult @default(PENDING) // 盈利/亏损/待定
  profit      Float?      // 收益金额
  profitRate  Float?      // 收益率
  lesson      String      // 经验教训
  mistakes    String?     // 错误分析
  improvements String?    // 改进建议
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // 关系
  userId     String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  decisionId String?
  decision   Decision?    @relation(fields: [decisionId], references: [id], onDelete: SetNull)

  @@map("reviews")
}

// 内容类型枚举
enum ContentType {
  ARTICLE    // 文章
  NEWS       // 新闻
  REPORT     // 研报
  BOOK       // 书籍
  VIDEO      // 视频
  PODCAST    // 播客
  NOTE       // 笔记
}

// 市场展望枚举
enum OutlookType {
  BULLISH    // 看涨
  BEARISH    // 看跌
  NEUTRAL    // 中性
}

// 行动类型枚举
enum ActionType {
  BUY        // 买入
  SELL       // 卖出
  HOLD       // 持有
}

// 决策状态枚举
enum DecisionStatus {
  PLANNING   // 计划中
  EXECUTED   // 已执行
  COMPLETED  // 已完成
  CANCELLED  // 已取消
}

// 复盘结果枚举
enum ReviewResult {
  PROFIT     // 盈利
  LOSS       // 亏损
  NEUTRAL    // 持平
  PENDING    // 待定
}

// ==================== 爬虫模块 ====================

// 爬虫数据源配置
model CrawlerSource {
  id            String          @id @default(cuid())
  name          String
  sourceType    SourceType
  sourceUrl     String          @unique
  enabled       Boolean         @default(true)
  fetchInterval Int             @default(3600)
  lastFetchAt   DateTime?
  lastEtag      String?
  authConfig    Json?
  options       Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  tasks         CrawlerTask[]

  @@map("crawler_sources")
}

// 爬虫任务记录
model CrawlerTask {
  id             String       @id @default(cuid())
  sourceId       String
  source         CrawlerSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  status         TaskStatus   @default(PENDING)
  scheduledAt    DateTime
  startedAt      DateTime?
  completedAt    DateTime?
  totalFetched   Int          @default(0)
  totalParsed    Int          @default(0)
  totalStored    Int          @default(0)
  errorMessage   String?
  errorStack     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("crawler_tasks")
}

// 数据源类型枚举
enum SourceType {
  RSS
  WECHAT
  TWITTER
  REDDIT
  HACKERNEWS
  CUSTOM
}

// 任务状态枚举
enum TaskStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  CANCELLED
}

// ==================== 雪球爬虫模块 ====================

// 雪球用户资料模型
model XueqiuUserProfile {
  uid            String   @id @map("uid") @db.VarChar
  screenName     String   @map("screen_name") @db.VarChar(100)
  followersCount Int      @default(0) @map("followers_count")
  friendsCount   Int      @default(0) @map("friends_count")
  description    String?  @db.Text
  rawData        Json?    @map("raw_data") @db.JsonB
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  lastCrawlAt    DateTime? @map("last_crawl_at") @db.Timestamptz

  @@index([lastCrawlAt])
  @@map("xueqiu_users")
}

// 雪球爬取任务模型
model XueqiuCrawlTask {
  id           String            @id @default(uuid()) @db.Uuid
  targetType   String            @default("") @map("target_type") @db.VarChar(50)
  targetId     String            @default("") @map("target_id") @db.VarChar
  status       XueqiuTaskStatus  @default(PENDING)
  priority     Int               @default(5)
  retryCount   Int               @default(0) @map("retry_count")
  errorMessage String?           @map("error_message") @db.Text
  result       Json?             @db.JsonB
  createdAt    DateTime          @default(now()) @map("created_at") @db.Timestamptz
  startedAt    DateTime?         @map("started_at") @db.Timestamptz
  completedAt  DateTime?         @map("completed_at") @db.Timestamptz

  @@index([status, priority, createdAt])
  @@map("xueqiu_crawl_tasks")
}

// Cookie池状态模型
model XueqiuCookie {
  id         String       @id @default(uuid()) @db.Uuid
  cookie     String       @db.Text
  status     CookieStatus @default(ACTIVE)
  expiresAt  DateTime     @map("expires_at") @db.Timestamptz
  lastUsedAt DateTime?    @map("last_used_at") @db.Timestamptz
  failCount  Int          @default(0) @map("fail_count")
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz

  @@index([status])
  @@index([expiresAt])
  @@map("xueqiu_cookies")
}

// 任务状态枚举
enum XueqiuTaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Cookie状态枚举
enum CookieStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

// 雪球动态模型
model XueqiuStatus {
  id            String   @id @default(uuid()) @db.Uuid
  statusId      String   @map("status_id") @db.VarChar(50)
  userId        String   @map("user_id") @db.VarChar
  content       String?  @db.Text
  createdAt     DateTime @map("created_at") @db.Timestamptz
  rawText       String?  @map("raw_text") @db.Text
  expandedText  String?  @map("expanded_text") @db.Text
  targetCount   Int      @default(0) @map("target_count")
  commentCount  Int      @default(0) @map("comment_count")
  likeCount     Int      @default(0) @map("like_count")
  repostCount   Int      @default(0) @map("repost_count")
  pictures      String[] @default([]) @map("pictures")
  rawData       Json?    @map("raw_data") @db.JsonB
  dbCreatedAt   DateTime @default(now()) @map("db_created_at") @db.Timestamptz
  dbUpdatedAt   DateTime @default(now()) @updatedAt @map("db_updated_at") @db.Timestamptz

  @@index([userId, createdAt])
  @@index([createdAt])
  @@unique([statusId])
  @@map("xueqiu_statuses")
}

// ==================== 微信公众号爬虫模块 ====================

// 账号状态枚举
enum AccountStatus {
  ACTIVE     // 活跃
  INACTIVE   // 停更
  DELETED    // 已删除
  BLOCKED    // 封禁
}

// 爬取模式枚举
enum CrawlMode {
  SOGOU      // 搜狗搜索入口
  WECHAT_PC  // 微信PC客户端
  AUTO       // 自动降级（优先搜狗，失败降级PC客户端）
}

// 爬取状态枚举
enum CrawlStatus {
  PENDING    // 待处理
  RUNNING    // 运行中
  SUCCESS    // 成功
  FAILED     // 失败
  PARTIAL    // 部分成功
}

// 微信公众号账户模型
model WechatAccount {
  id              String        @id @default(cuid())
  accountId       String        @unique @map("account_id") @db.VarChar(100)
  name            String        @db.VarChar(200)
  introduction    String?       @db.Text
  avatarUrl       String?       @map("avatar_url") @db.VarChar(500)
  status          AccountStatus @default(ACTIVE)
  crawlMode       CrawlMode     @default(AUTO)
  followersCount  Int           @default(0) @map("followers_count")
  publishCount    Int           @default(0) @map("publish_count")
  lastCrawlAt     DateTime?     @map("last_crawl_at") @db.Timestamptz
  lastPublishAt   DateTime?     @map("last_publish_at") @db.Timestamptz
  enabled         Boolean       @default(true)
  tags            String[]      @default([])
  rawData         Json?         @map("raw_data") @db.JsonB
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  articles        WechatArticle[]
  crawlLogs       WechatCrawlLog[]

  @@index([status])
  @@index([enabled])
  @@index([lastCrawlAt])
  @@map("wechat_accounts")
}

// 微信公众号文章模型
model WechatArticle {
  id              String       @id @default(cuid())
  articleId       String       @unique @map("article_id") @db.VarChar(100)
  accountId       String       @map("account_id") @db.VarChar(100)
  title           String       @db.VarChar(500)
  author          String?      @db.VarChar(200)
  digest          String?      @db.Text
  content         String?      @db.Text
  contentHtml     String?      @map("content_html") @db.Text
  coverUrl        String?      @map("cover_url") @db.VarChar(500)
  sourceUrl       String       @map("source_url") @db.VarChar(500)
  publishTime     DateTime     @map("publish_time") @db.Timestamptz
  readCount       Int          @default(0) @map("read_count")
  likeCount       Int          @default(0) @map("like_count")
  commentCount    Int          @default(0) @map("comment_count")
  rewardCount     Int          @default(0) @map("reward_count")
  isOriginal      Boolean      @default(false) @map("is_original")
  copyrightStat   Int?         @default(0) @map("copyright_stat")
  rawData         Json?        @map("raw_data") @db.JsonB
  dbCreatedAt     DateTime     @default(now()) @map("db_created_at") @db.Timestamptz
  dbUpdatedAt     DateTime     @default(now()) @updatedAt @map("db_updated_at") @db.Timestamptz

  account         WechatAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([publishTime])
  @@index([publishTime(sort: Desc)], name: "wechat_articles_publish_time_desc_idx")
  @@map("wechat_articles")
}

// 微信爬取日志模型
model WechatCrawlLog {
  id              String       @id @default(cuid())
  accountId       String       @map("account_id")
  account         WechatAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  crawlMode       CrawlMode    @map("crawl_mode")
  status          CrawlStatus
  articlesFetched Int          @default(0) @map("articles_fetched")
  articlesStored  Int          @default(0) @map("articles_stored")
  errorMessage    String?      @map("error_message") @db.Text
  errorStack      String?      @map("error_stack") @db.Text
  duration        Int?         @map("duration") // 执行时长（毫秒）
  startedAt       DateTime     @default(now()) @map("started_at") @db.Timestamptz
  completedAt     DateTime?    @map("completed_at") @db.Timestamptz
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz

  @@index([accountId])
  @@index([status])
  @@index([startedAt])
  @@map("wechat_crawl_logs")
}

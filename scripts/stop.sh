#!/bin/bash

################################################################################
# æŠ•èµ„ç ”ç©¶ç³»ç»Ÿ - åœæ­¢æ‰€æœ‰æœåŠ¡è„šæœ¬
#
# åŠŸèƒ½ï¼š
# 1. åœæ­¢å‰ç«¯æœåŠ¡ (Next.js on port 3001)
# 2. åœæ­¢åç«¯æœåŠ¡ (NestJS on port 3000)
# 3. åœæ­¢æ•°æ®åº“æœåŠ¡ (PostgreSQL + Redis)
################################################################################

set -e

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

log_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}âš ${NC} $1"
}

log_error() {
    echo -e "${RED}âœ—${NC} $1"
}

# æ‰“å°å¸¦é¢œè‰²çš„æ ‡é¢˜
print_title() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

################################################################################
# åœæ­¢æŒ‡å®šç«¯å£çš„è¿›ç¨‹
################################################################################
stop_process_on_port() {
    local port=$1
    local service_name=$2

    log_info "æ£€æŸ¥ ${service_name} (ç«¯å£ ${port})..."

    # æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
    local pid=$(lsof -ti:${port} 2>/dev/null || true)

    if [ -n "$pid" ]; then
        log_warn "å‘ç°è¿›ç¨‹ PID: ${pid}"
        kill -9 $pid 2>/dev/null || true
        sleep 1
        log_success "${service_name} å·²åœæ­¢"
    else
        log_info "${service_name} æœªè¿è¡Œ"
    fi
}

################################################################################
# åœæ­¢æŒ‡å®šåç§°çš„è¿›ç¨‹
################################################################################
stop_process_by_name() {
    local process_name=$1
    local service_name=$2

    log_info "æ£€æŸ¥ ${service_name}..."

    # æŸ¥æ‰¾è¿›ç¨‹
    local pids=$(pgrep -f "${process_name}" 2>/dev/null || true)

    if [ -n "$pids" ]; then
        log_warn "å‘ç°è¿›ç¨‹: ${pids}"
        pkill -9 -f "${process_name}" 2>/dev/null || true
        sleep 1
        log_success "${service_name} å·²åœæ­¢"
    else
        log_info "${service_name} æœªè¿è¡Œ"
    fi
}

################################################################################
# ä¸»æµç¨‹
################################################################################

print_title "ğŸ›‘ æŠ•èµ„ç ”ç©¶ç³»ç»Ÿ - åœæ­¢æ‰€æœ‰æœåŠ¡"

################################################################################
# æ­¥éª¤ 1: åœæ­¢å‰ç«¯æœåŠ¡
################################################################################
print_title "æ­¥éª¤ 1/3: åœæ­¢å‰ç«¯æœåŠ¡"
stop_process_on_port 3001 "å‰ç«¯æœåŠ¡ (Next.js)"
stop_process_by_name "next dev" "Next.js å¼€å‘æœåŠ¡å™¨"

################################################################################
# æ­¥éª¤ 2: åœæ­¢åç«¯æœåŠ¡
################################################################################
print_title "æ­¥éª¤ 2/3: åœæ­¢åç«¯æœåŠ¡"
stop_process_on_port 3000 "åç«¯æœåŠ¡ (NestJS)"
stop_process_by_name "nest start" "NestJS å¼€å‘æœåŠ¡å™¨"

################################################################################
# æ­¥éª¤ 3: åœæ­¢æ•°æ®åº“æœåŠ¡
################################################################################
print_title "æ­¥éª¤ 3/3: åœæ­¢æ•°æ®åº“æœåŠ¡"

# æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
if docker info > /dev/null 2>&1; then
    log_info "æ£€æŸ¥ Docker å®¹å™¨..."

    # æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨
    if docker-compose ps | grep -q "Up"; then
        log_info "åœæ­¢æ•°æ®åº“å®¹å™¨..."
        docker-compose down -v 2>/dev/null || docker-compose down
        log_success "æ•°æ®åº“å®¹å™¨å·²åœæ­¢å¹¶åˆ é™¤"
    else
        log_info "æ•°æ®åº“å®¹å™¨æœªè¿è¡Œ"
    fi
else
    log_warn "Docker æœªè¿è¡Œï¼Œè·³è¿‡æ•°æ®åº“åœæ­¢"
fi

################################################################################
# æœ€ç»ˆéªŒè¯
################################################################################
print_title "éªŒè¯æ¸…ç†ç»“æœ"

log_info "æ£€æŸ¥è¿›ç¨‹æ®‹ç•™..."

# æ£€æŸ¥ç«¯å£å ç”¨
port_3000_in_use=$(lsof -ti:3000 2>/dev/null || true)
port_3001_in_use=$(lsof -ti:3001 2>/dev/null || true)

if [ -n "$port_3000_in_use" ]; then
    log_error "ç«¯å£ 3000 ä»è¢«å ç”¨: ${port_3000_in_use}"
else
    log_success "ç«¯å£ 3000 å·²é‡Šæ”¾"
fi

if [ -n "$port_3001_in_use" ]; then
    log_error "ç«¯å£ 3001 ä»è¢«å ç”¨: ${port_3001_in_use}"
else
    log_success "ç«¯å£ 3001 å·²é‡Šæ”¾"
fi

# æ£€æŸ¥ Docker å®¹å™¨
if docker info > /dev/null 2>&1; then
    running_containers=$(docker-compose ps -q 2>/dev/null | wc -l | tr -d ' ')
    if [ "$running_containers" -gt 0 ]; then
        log_warn "ä»æœ‰ ${running_containers} ä¸ªå®¹å™¨åœ¨è¿è¡Œ"
    else
        log_success "æ‰€æœ‰æ•°æ®åº“å®¹å™¨å·²åœæ­¢"
    fi
fi

################################################################################
# å®Œæˆ
################################################################################
print_title "âœ… æ¸…ç†å®Œæˆ"
echo ""
log_info "æ‰€æœ‰æœåŠ¡å·²åœæ­¢ï¼š"
echo "  â€¢ å‰ç«¯æœåŠ¡ (Next.js)"
echo "  â€¢ åç«¯æœåŠ¡ (NestJS)"
echo "  â€¢ æ•°æ®åº“æœåŠ¡ (PostgreSQL + Redis)"
echo ""
log_info "é‡æ–°å¯åŠ¨è¯·è¿è¡Œ: pnpm dev"
echo ""
